# ChatGPT API 出題文生成 - 要求定義

## 概要

ChatGPT（OpenAI）API を利用して、出題文を動的に生成する機能を追加する。
現在のローカル JSON からの出題に加え、API から多様な文章を取得できるようにする。

## 背景・目的

- 現在の出題文は `sentences.json` に固定された10文のみであり、繰り返しプレイすると飽きやすい
- ChatGPT API を活用することで、毎回異なる出題文を生成し、ゲームの新鮮さを維持する
- 将来的にはテーマ指定（動物、食べ物など）による出題カスタマイズも視野に入れる

## ユーザーストーリー

### US-101: API から出題文を取得する

```
プレイヤーとして、
毎回異なる出題文でタイピング対戦をしたい。
なぜなら、同じ文章の繰り返しでは飽きてしまうからだ。
```

**受け入れ条件:**

- タイトル画面で「API から出題」を選択できる
- ゲーム開始時に ChatGPT API から出題文が生成される
- 生成された文章が正しくローマ字変換され、通常のゲームとして遊べる
- API キーが未設定の場合はエラーメッセージを表示する

### US-102: API キーを設定する

```
プレイヤーとして、
自分の OpenAI API キーを設定してゲームで使いたい。
なぜなら、API 利用には個人のキーが必要だからだ。
```

**受け入れ条件:**

- タイトル画面に API キー設定 UI がある
- API キーは localStorage に保存され、再入力不要
- API キーの表示/非表示を切り替えられる
- API キーを削除（クリア）できる

### US-103: API 未設定時のフォールバック

```
プレイヤーとして、
API キーを設定していなくても遊びたい。
なぜなら、API なしでも基本的なゲームは楽しめるからだ。
```

**受け入れ条件:**

- API キーが未設定の場合は従来通りローカル JSON から出題される
- 「API から出題」ボタンは API キー設定後にのみ有効になる

## 機能要件

### FR-101: 出題ソース選択

- タイトル画面に出題ソースの選択 UI を追加する
  - ローカル（従来通り）
  - ChatGPT API
- API キーが未設定の場合、ChatGPT API の選択肢は無効（disabled）にする

### FR-102: ChatGPT API 連携

- OpenAI Chat Completions API (`gpt-4o-mini`) を使用する
- 1回のリクエストで10文の出題文を生成する
- レスポンスは `{ japanese: string, reading: string }[]` 形式で取得する
- 生成された文章は `RomajiConverter` でチャンク変換し、既存のゲームフローで使用する

### FR-103: API キー管理

- API キーは `localStorage` に保存する
- タイトル画面に API キー入力フィールドを設ける
- パスワード入力形式（マスク表示）とし、表示トグルを用意する
- 「保存」「クリア」ボタンを設ける

### FR-104: エラーハンドリング

- API 呼び出し失敗時はエラーメッセージを表示する
- タイムアウト（15秒）を設定する
- エラー時はローカル出題へのフォールバックを提案する

### FR-105: ローディング表示

- API から出題文を取得中はローディングインジケータを表示する
- ローディング中はゲーム開始ボタンを無効にする

## 非機能要件

### NFR-101: セキュリティ

- API キーはブラウザの `localStorage` にのみ保存する（サーバーには送信しない）
- API キーはフロントエンドから直接 OpenAI API に送信する（プロキシ不要）
- 本アプリはローカル環境での利用を前提とするため、フロントエンド直接通信で許容する

### NFR-102: パフォーマンス

- API レスポンスの取得は5秒以内を目標とする
- ローディング表示でユーザー体験を損なわないようにする

### NFR-103: コスト

- `gpt-4o-mini` を使用しコストを抑える
- 1回のリクエストで10文をまとめて生成する

## 追加要件

### FR-106: 連続対戦時の出題文再利用

- 「もう一度対戦」を選択した場合、同じ出題文で再スタートする（API 再呼び出しなし）
- 出題ソースを変えたい場合は「タイトルへ」から戻って選び直す

### FR-107: ローカル出題データの拡充

- `sentences.json` の出題文を現在の10文から30文に増やす
- 難易度や文の長さにバリエーションを持たせる
- 漢字の読みが一意に決まる文のみ使用する

## 制約事項

- 外部ライブラリの追加は最小限に抑える（`openai` npm パッケージは使用せず `fetch` で直接呼び出す）
- 既存のゲームロジック（Domain 層）には変更を加えない
- SentenceRepository インターフェースを遵守する
